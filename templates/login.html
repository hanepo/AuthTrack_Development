<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AuthTrack - Login</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="/static/css/style.css" />
  </head>
  <body>
    <div class="login-container">
      <div class="login-box">
        <div class="logo" style="justify-content: center; margin-bottom: 20px">
          <i class="fa-solid fa-network-wired"></i> AuthTrack
        </div>
        <h1>Welcome Back</h1>
        <p class="subtitle">Sign in to continue to your dashboard</p>

        <div id="errorMsg" class="alert alert-danger" style="display: none">
          <i class="fa-solid fa-circle-exclamation"></i>
          <span id="errorText"></span>
        </div>

        <form id="loginForm">
          <div class="form-group">
            <label for="email">Email Address</label>
            <input
              type="email"
              id="email"
              class="form-control"
              placeholder="you@example.com"
              required
            />
          </div>

          <div class="form-group">
            <label for="password">Password</label>
            <input
              type="password"
              id="password"
              class="form-control"
              placeholder="••••••••"
              required
            />
          </div>

          <button
            type="submit"
            class="btn btn-primary"
            style="width: 100%; margin-top: 10px"
          >
            <i class="fa-solid fa-right-to-bracket"></i> Sign In
          </button>
        </form>

        <div style="text-align: center; margin-top: 15px">
          <a
            href="#"
            id="forgotPasswordLink"
            style="
              color: var(--primary-color);
              text-decoration: none;
              font-size: 13px;
              font-weight: 500;
            "
          >
            <i class="fa-solid fa-key"></i> Forgot Password?
          </a>
        </div>

        <p
          style="
            text-align: center;
            margin-top: 6px;
            font-size: 12px;
            color: var(--text-muted);
          "
        >
          Don't have an account?
          <a
            href="/signup"
            style="
              color: var(--primary-color);
              text-decoration: none;
              font-weight: 500;
            "
            >Sign up</a
          >
          to create one.
        </p>

        <!-- Forgot Password Modal -->
        <div
          id="forgotPasswordModal"
          style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
          "
        >
          <div
            style="
              background: var(--bg-card);
              padding: 30px;
              border-radius: 12px;
              max-width: 400px;
              width: 90%;
            "
          >
            <h2 style="margin-bottom: 10px; color: var(--text)">
              Reset Password
            </h2>
            <p
              style="
                font-size: 13px;
                color: var(--text-muted);
                margin-bottom: 20px;
              "
            >
              Enter your email address and we'll send you a password reset link.
            </p>

            <div
              id="resetSuccessMsg"
              class="alert"
              style="
                display: none;
                background: var(--success);
                color: white;
                margin-bottom: 15px;
              "
            >
              <i class="fa-solid fa-check-circle"></i>
              <span>Password reset email sent! Check your inbox.</span>
            </div>

            <div
              id="resetErrorMsg"
              class="alert alert-danger"
              style="display: none; margin-bottom: 15px"
            >
              <i class="fa-solid fa-circle-exclamation"></i>
              <span id="resetErrorText"></span>
            </div>

            <form id="resetPasswordForm">
              <div class="form-group">
                <label for="resetEmail">Email Address</label>
                <input
                  type="email"
                  id="resetEmail"
                  class="form-control"
                  placeholder="you@example.com"
                  required
                />
              </div>

              <div style="display: flex; gap: 10px; margin-top: 20px">
                <button type="submit" class="btn btn-primary" style="flex: 1">
                  <i class="fa-solid fa-paper-plane"></i> Send Reset Link
                </button>
                <button
                  type="button"
                  class="btn"
                  style="flex: 1"
                  onclick="closeForgotPasswordModal()"
                >
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { auth } from "/static/js/firebase-config.js";
      import {
        signInWithEmailAndPassword,
        sendPasswordResetEmail,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      const form = document.getElementById("loginForm");
      const errorMsg = document.getElementById("errorMsg");
      const errorText = document.getElementById("errorText");

      function showError(msg) {
        errorText.textContent = msg;
        errorMsg.style.display = "flex";
      }

      function hideError() {
        errorMsg.style.display = "none";
      }

      // Forgot Password Modal
      document
        .getElementById("forgotPasswordLink")
        .addEventListener("click", (e) => {
          e.preventDefault();
          document.getElementById("forgotPasswordModal").style.display = "flex";
        });

      window.closeForgotPasswordModal = function () {
        document.getElementById("forgotPasswordModal").style.display = "none";
        document.getElementById("resetSuccessMsg").style.display = "none";
        document.getElementById("resetErrorMsg").style.display = "none";
        document.getElementById("resetEmail").value = "";
      };

      document
        .getElementById("resetPasswordForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const email = document.getElementById("resetEmail").value;
          const resetErrorMsg = document.getElementById("resetErrorMsg");
          const resetErrorText = document.getElementById("resetErrorText");
          const resetSuccessMsg = document.getElementById("resetSuccessMsg");

          // Hide messages
          resetErrorMsg.style.display = "none";
          resetSuccessMsg.style.display = "none";

          try {
            await sendPasswordResetEmail(auth, email);
            resetSuccessMsg.style.display = "flex";
            setTimeout(() => {
              closeForgotPasswordModal();
            }, 3000);
          } catch (error) {
            console.error("Password reset error:", error);
            resetErrorText.textContent =
              error.code === "auth/user-not-found"
                ? "No account found with this email"
                : "Failed to send reset email. Please try again.";
            resetErrorMsg.style.display = "flex";
          }
        });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        hideError();

        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;

        try {
          // Authenticate with Firebase
          const userCredential = await signInWithEmailAndPassword(
            auth,
            email,
            password,
          );
          const user = userCredential.user;

          // Request 2FA from server
          const response = await fetch("/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email: email, userId: user.uid }),
          });

          const data = await response.json();

          if (data.success) {
            window.location.href = "/2fa";
          } else {
            showError(data.message || "Login failed");
          }
        } catch (error) {
          console.error("Login error:", error);
          if (error.code === "auth/user-not-found") {
            showError("User not found");
          } else if (error.code === "auth/wrong-password") {
            showError("Incorrect password");
          } else if (error.code === "auth/invalid-email") {
            showError("Invalid email address");
          } else {
            showError("Login failed. Please try again.");
          }
        }
      });
    </script>
  </body>
</html>
