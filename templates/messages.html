<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AuthTrack - User Requests</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="/static/css/style.css" />
    <style>
      .messages-container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .message-filters {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        padding: 15px;
        background: var(--bg-card);
        border-radius: 10px;
        border: 1px solid var(--border);
      }

      .filter-btn {
        padding: 8px 16px;
        background: var(--bg-dark);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.2s;
        font-size: 13px;
      }

      .filter-btn:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }

      .filter-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }

      .messages-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .message-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 20px;
        transition: all 0.2s;
      }

      .message-card:hover {
        border-color: var(--primary);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
      }

      .message-card.unread {
        background: rgba(59, 130, 246, 0.05);
        border-left: 3px solid var(--primary);
      }

      .message-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 10px;
      }

      .message-user {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        background: var(--primary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 16px;
      }

      .user-info h4 {
        margin: 0;
        font-size: 14px;
        font-weight: 600;
      }

      .user-info p {
        margin: 0;
        font-size: 12px;
        color: var(--text-muted);
      }

      .message-time {
        font-size: 12px;
        color: var(--text-muted);
      }

      .message-subject {
        font-size: 15px;
        font-weight: 600;
        margin-bottom: 10px;
        color: var(--text-main);
      }

      .message-content {
        font-size: 13px;
        color: var(--text-muted);
        line-height: 1.6;
        margin-bottom: 15px;
      }

      .message-actions {
        display: flex;
        gap: 10px;
      }

      .message-actions button {
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
      }

      .btn-reply {
        background: var(--primary);
        color: white;
      }

      .btn-reply:hover {
        background: #2563eb;
      }

      .btn-mark-read {
        background: var(--bg-dark);
        color: var(--text-main);
        border: 1px solid var(--border);
      }

      .btn-mark-read:hover {
        background: var(--success);
        color: white;
        border-color: var(--success);
      }

      .btn-delete {
        background: var(--danger);
        color: white;
      }

      .btn-delete:hover {
        background: #dc2626;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-muted);
      }

      .empty-state i {
        font-size: 48px;
        margin-bottom: 15px;
        opacity: 0.5;
      }

      .stats-bar {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-item {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 15px;
        text-align: center;
      }

      .stat-item .value {
        font-size: 28px;
        font-weight: 600;
        color: var(--primary);
      }

      .stat-item .label {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 5px;
      }

      /* Reply Modal */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal {
        background: var(--bg-card);
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow: auto;
        padding: 0;
      }

      .modal-header {
        padding: 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h3 {
        margin: 0;
        font-size: 18px;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: var(--text-muted);
        cursor: pointer;
      }

      .modal-body {
        padding: 20px;
      }

      .modal-body .form-group {
        margin-bottom: 15px;
      }

      .modal-body label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 5px;
      }

      .modal-body textarea {
        width: 100%;
        padding: 10px;
        background: var(--bg-dark);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text-main);
        font-size: 13px;
        resize: vertical;
        min-height: 120px;
      }

      .modal-body textarea:focus {
        outline: none;
        border-color: var(--primary);
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="logo">
          <i class="fa-solid fa-network-wired"></i> AuthTrack
        </div>
        <nav>
          <a href="/dashboard" class="nav-item">
            <i class="fa-solid fa-chart-line"></i> Dashboard
          </a>
          <a href="/traffic" class="nav-item">
            <i class="fa-solid fa-signal"></i> Traffic Analysis
          </a>
          <a href="/devices" class="nav-item">
            <i class="fa-solid fa-laptop"></i> Device Settings
          </a>
          <a href="/logs" class="nav-item">
            <i class="fa-solid fa-file-lines"></i> Logs & Reports
          </a>
          <a href="/messages" class="nav-item active">
            <i class="fa-solid fa-envelope"></i> User Requests
          </a>
          <a href="/profile" class="nav-item">
            <i class="fa-solid fa-user"></i> Profile
          </a>
          <a href="/logout" class="nav-item" style="margin-top: auto">
            <i class="fa-solid fa-right-from-bracket"></i> Logout
          </a>
        </nav>

        <!-- System Stats -->
        <div style="margin-top: auto">
          <div class="system-stats">
            <div class="title">
              <i class="fa-solid fa-microchip"></i> System Status
            </div>
            <div class="sys-stat">
              <div class="header">
                <span>CPU</span>
                <span id="cpuVal">0%</span>
              </div>
              <div class="bar">
                <div class="fill cpu" id="cpuBar" style="width: 0%"></div>
              </div>
            </div>
            <div class="sys-stat">
              <div class="header">
                <span>Memory</span>
                <span id="memVal">0%</span>
              </div>
              <div class="bar">
                <div class="fill memory" id="memBar" style="width: 0%"></div>
              </div>
            </div>
            <div class="sys-stat">
              <div class="header">
                <span>Disk</span>
                <span id="diskVal">0%</span>
              </div>
              <div class="bar">
                <div class="fill disk" id="diskBar" style="width: 0%"></div>
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <header>
          <div class="page-title">
            <h1>
              <i class="fa-solid fa-envelope"></i> User Requests & Messages
            </h1>
            <p
              style="font-size: 13px; color: var(--text-muted); margin-top: 5px"
            >
              Manage and respond to user requests
            </p>
          </div>
          <div class="user-info">
            <span id="userEmail">{{ session.get('user_email', 'Admin') }}</span>
          </div>
        </header>

        <div class="messages-container">
          <!-- Stats Bar -->
          <div class="stats-bar">
            <div class="stat-item">
              <div class="value" id="totalMessages">0</div>
              <div class="label">Total Requests</div>
            </div>
            <div class="stat-item">
              <div class="value" id="unreadMessages">0</div>
              <div class="label">Unread</div>
            </div>
            <div class="stat-item">
              <div class="value" id="todayMessages">0</div>
              <div class="label">Today</div>
            </div>
            <div class="stat-item">
              <div class="value" id="activeUsers">0</div>
              <div class="label">Active Users</div>
            </div>
          </div>

          <!-- Filters -->
          <div class="message-filters">
            <button class="filter-btn active" onclick="filterMessages('all')">
              <i class="fa-solid fa-inbox"></i> All
            </button>
            <button class="filter-btn" onclick="filterMessages('unread')">
              <i class="fa-solid fa-envelope"></i> Unread
            </button>
            <button class="filter-btn" onclick="filterMessages('read')">
              <i class="fa-solid fa-envelope-open"></i> Read
            </button>
            <button class="filter-btn" onclick="filterMessages('today')">
              <i class="fa-solid fa-calendar-day"></i> Today
            </button>
            <div style="margin-left: auto">
              <button class="btn btn-primary" onclick="markAllAsRead()">
                <i class="fa-solid fa-check-double"></i> Mark All Read
              </button>
            </div>
          </div>

          <!-- Messages List -->
          <div class="messages-list" id="messagesList">
            <!-- Messages will be loaded here -->
          </div>
        </div>
      </main>
    </div>

    <!-- Reply Modal -->
    <div class="modal-overlay" id="replyModal">
      <div class="modal">
        <div class="modal-header">
          <h3><i class="fa-solid fa-reply"></i> Reply to User</h3>
          <button class="modal-close" onclick="closeReplyModal()">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>To: <span id="replyToEmail"></span></label>
          </div>
          <div class="form-group">
            <label>Subject: Re: <span id="replySubject"></span></label>
          </div>
          <div class="form-group">
            <label>Message</label>
            <textarea
              id="replyContent"
              placeholder="Type your reply..."
            ></textarea>
          </div>
          <button
            class="btn btn-primary"
            onclick="sendReply()"
            style="width: 100%"
          >
            <i class="fa-solid fa-paper-plane"></i> Send Reply
          </button>
        </div>
      </div>
    </div>

    <script>
      let allMessages = [];
      let currentFilter = "all";
      let currentReplyMessageId = null;

      // Load Messages
      async function loadMessages() {
        try {
          const res = await fetch("/api/messages");
          allMessages = await res.json();

          // Calculate stats
          const unread = allMessages.filter((m) => !m.read).length;
          const today = allMessages.filter((m) => {
            const msgDate = new Date(m.timestamp).toDateString();
            const todayDate = new Date().toDateString();
            return msgDate === todayDate;
          }).length;

          document.getElementById("totalMessages").textContent =
            allMessages.length;
          document.getElementById("unreadMessages").textContent = unread;
          document.getElementById("todayMessages").textContent = today;

          // Get active users count
          const usersRes = await fetch("/api/users");
          const users = await usersRes.json();
          const activeCount = users.filter((u) => u.online).length;
          document.getElementById("activeUsers").textContent = activeCount;

          renderMessages();
        } catch (err) {
          console.error("Error loading messages:", err);
        }
      }

      // Filter Messages
      function filterMessages(type) {
        currentFilter = type;

        // Update active button
        document.querySelectorAll(".filter-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        event.target.closest(".filter-btn").classList.add("active");

        renderMessages();
      }

      // Render Messages
      function renderMessages() {
        let filtered = allMessages;

        if (currentFilter === "unread") {
          filtered = allMessages.filter((m) => !m.read);
        } else if (currentFilter === "read") {
          filtered = allMessages.filter((m) => m.read);
        } else if (currentFilter === "today") {
          const todayDate = new Date().toDateString();
          filtered = allMessages.filter((m) => {
            const msgDate = new Date(m.timestamp).toDateString();
            return msgDate === todayDate;
          });
        }

        const container = document.getElementById("messagesList");

        if (filtered.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="fa-solid fa-inbox"></i>
              <h3>No Messages</h3>
              <p>You don't have any ${
                currentFilter === "all" ? "" : currentFilter
              } messages.</p>
            </div>
          `;
          return;
        }

        container.innerHTML = filtered
          .map((msg) => {
            const initials = msg.fromEmail
              ? msg.fromEmail.substring(0, 2).toUpperCase()
              : "U?";
            const timeAgo = formatTimeAgo(msg.timestamp);

            return `
            <div class="message-card ${!msg.read ? "unread" : ""}" data-id="${
              msg.id
            }">
              <div class="message-header">
                <div class="message-user">
                  <div class="user-avatar">${initials}</div>
                  <div class="user-info">
                    <h4>${msg.fromEmail || "Unknown User"}</h4>
                    <p>User ID: ${msg.fromUserId || "N/A"}</p>
                  </div>
                </div>
                <div class="message-time">
                  <i class="fa-solid fa-clock"></i> ${timeAgo}
                </div>
              </div>
              <div class="message-subject">${msg.subject || "No Subject"}</div>
              <div class="message-content">${msg.content || "No content"}</div>
              <div class="message-actions">
                <button class="btn-reply" onclick="openReplyModal('${msg.id}')">
                  <i class="fa-solid fa-reply"></i> Reply
                </button>
                ${
                  !msg.read
                    ? `
                  <button class="btn-mark-read" onclick="markAsRead('${msg.id}')">
                    <i class="fa-solid fa-check"></i> Mark Read
                  </button>
                `
                    : ""
                }
                <button class="btn-delete" onclick="deleteMessage('${msg.id}')">
                  <i class="fa-solid fa-trash"></i> Delete
                </button>
              </div>
            </div>
          `;
          })
          .join("");
      }

      // Open Reply Modal
      function openReplyModal(messageId) {
        const msg = allMessages.find((m) => m.id === messageId);
        if (!msg) return;

        currentReplyMessageId = messageId;
        document.getElementById("replyToEmail").textContent = msg.fromEmail;
        document.getElementById("replySubject").textContent = msg.subject;
        document.getElementById("replyContent").value = "";
        document.getElementById("replyModal").classList.add("active");

        // Mark as read when opened
        if (!msg.read) {
          markAsRead(messageId, false);
        }
      }

      // Close Reply Modal
      function closeReplyModal() {
        document.getElementById("replyModal").classList.remove("active");
        currentReplyMessageId = null;
      }

      // Send Reply
      async function sendReply() {
        const msg = allMessages.find((m) => m.id === currentReplyMessageId);
        if (!msg) return;

        const content = document.getElementById("replyContent").value.trim();
        if (!content) {
          alert("Please enter a reply message");
          return;
        }

        try {
          await fetch("/api/messages", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              toUserId: msg.fromUserId,
              subject: "Re: " + msg.subject,
              content: content,
              type: "reply",
            }),
          });

          alert("Reply sent successfully!");
          closeReplyModal();
          loadMessages();
        } catch (err) {
          console.error("Error sending reply:", err);
          alert("Failed to send reply");
        }
      }

      // Mark as Read
      async function markAsRead(messageId, reload = true) {
        try {
          await fetch(`/api/messages/${messageId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ read: true }),
          });

          if (reload) {
            loadMessages();
          } else {
            // Update local state
            const msg = allMessages.find((m) => m.id === messageId);
            if (msg) msg.read = true;
          }
        } catch (err) {
          console.error("Error marking as read:", err);
        }
      }

      // Mark All as Read
      async function markAllAsRead() {
        if (!confirm("Mark all messages as read?")) return;

        const unreadMessages = allMessages.filter((m) => !m.read);

        try {
          await Promise.all(
            unreadMessages.map((msg) =>
              fetch(`/api/messages/${msg.id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ read: true }),
              })
            )
          );

          loadMessages();
        } catch (err) {
          console.error("Error marking all as read:", err);
          alert("Failed to mark all as read");
        }
      }

      // Delete Message
      async function deleteMessage(messageId) {
        if (!confirm("Delete this message?")) return;

        try {
          await fetch(`/api/messages/${messageId}`, {
            method: "DELETE",
          });

          loadMessages();
        } catch (err) {
          console.error("Error deleting message:", err);
          alert("Failed to delete message");
        }
      }

      // Format Time Ago
      function formatTimeAgo(timestamp) {
        if (!timestamp) return "unknown";
        const now = new Date();
        const then = new Date(timestamp);
        const seconds = Math.floor((now - then) / 1000);

        if (seconds < 60) return "just now";
        if (seconds < 3600) return Math.floor(seconds / 60) + " minutes ago";
        if (seconds < 86400) return Math.floor(seconds / 3600) + " hours ago";
        if (seconds < 604800) return Math.floor(seconds / 86400) + " days ago";
        return then.toLocaleDateString();
      }

      // Update System Stats
      async function updateSystemStats() {
        try {
          const res = await fetch("/api/system/stats");
          const data = await res.json();

          document.getElementById("cpuVal").textContent = data.cpu + "%";
          document.getElementById("cpuBar").style.width = data.cpu + "%";

          document.getElementById("memVal").textContent = data.memory + "%";
          document.getElementById("memBar").style.width = data.memory + "%";

          document.getElementById("diskVal").textContent = data.disk + "%";
          document.getElementById("diskBar").style.width = data.disk + "%";
        } catch (err) {
          console.error("System stats error:", err);
        }
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        loadMessages();
        updateSystemStats();
        // Refresh every 30 seconds
        setInterval(loadMessages, 30000);
        setInterval(updateSystemStats, 2000);
      });
    </script>
  </body>
</html>
