<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AuthTrack - Profile</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="/static/css/style.css" />
    <style>
      /* System Stats Styles */
      .system-stats {
        padding: 15px;
        background: var(--bg-card);
        border-radius: 10px;
        border: 1px solid var(--border);
      }
      .system-stats .title {
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 15px;
        color: var(--text-muted);
      }
      .sys-stat {
        margin-bottom: 15px;
      }
      .sys-stat .header {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        margin-bottom: 5px;
      }
      .sys-stat .bar {
        height: 6px;
        background: var(--bg-dark);
        border-radius: 3px;
        overflow: hidden;
      }
      .sys-stat .fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s;
      }
      .sys-stat .fill.cpu {
        background: var(--success);
      }
      .sys-stat .fill.memory {
        background: var(--warning);
      }
      .sys-stat .fill.disk {
        background: var(--primary);
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="logo">
          <i class="fa-solid fa-network-wired"></i> AuthTrack
        </div>
        <nav>
          <a href="/dashboard" class="nav-item">
            <i class="fa-solid fa-chart-line"></i> Dashboard
          </a>
          <a href="/traffic" class="nav-item">
            <i class="fa-solid fa-signal"></i> Traffic Analysis
          </a>
          <a href="/devices" class="nav-item">
            <i class="fa-solid fa-laptop"></i> Device Settings
          </a>
          <a href="/logs" class="nav-item">
            <i class="fa-solid fa-file-lines"></i> Logs & Reports
          </a>
          <a href="/messages" class="nav-item">
            <i class="fa-solid fa-envelope"></i> User Requests
          </a>
          <a href="/profile" class="nav-item active">
            <i class="fa-solid fa-user"></i> Profile
          </a>
          <a href="/logout" class="nav-item" style="margin-top: auto">
            <i class="fa-solid fa-right-from-bracket"></i> Logout
          </a>
        </nav>

        <!-- System Stats moved to bottom -->
        <div style="margin-top: auto">
          <div class="system-stats">
            <div class="title">
              <i class="fa-solid fa-microchip"></i> System Status
            </div>
            <div class="sys-stat">
              <div class="header">
                <span>CPU</span>
                <span id="cpuVal">0%</span>
              </div>
              <div class="bar">
                <div class="fill cpu" id="cpuBar" style="width: 0%"></div>
              </div>
            </div>
            <div class="sys-stat">
              <div class="header">
                <span>Memory</span>
                <span id="memVal">0%</span>
              </div>
              <div class="bar">
                <div class="fill memory" id="memBar" style="width: 0%"></div>
              </div>
            </div>
            <div class="sys-stat">
              <div class="header">
                <span>Disk</span>
                <span id="diskVal">0%</span>
              </div>
              <div class="bar">
                <div class="fill disk" id="diskBar" style="width: 0%"></div>
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <header>
          <div class="page-title">
            <h1>Profile</h1>
          </div>
          <div style="display: flex; align-items: center; gap: 15px">
            <span class="role-badge" id="userRole">USER</span>
            <span style="color: var(--text-muted); font-size: 14px"
              >{{ user_email }}</span
            >
          </div>
        </header>

        <div class="grid-2">
          <!-- My Profile -->
          <div class="card">
            <div class="card-title">
              <i class="fa-solid fa-user-circle"></i> My Profile
            </div>
            <form id="profileForm">
              <div class="form-group">
                <label>Email</label>
                <input
                  type="email"
                  id="profileEmail"
                  class="form-control"
                  readonly
                />
              </div>
              <div class="form-group">
                <label>Display Name</label>
                <input
                  type="text"
                  id="profileName"
                  class="form-control"
                  placeholder="Your name"
                />
                <small
                  class="user-only"
                  style="color: var(--text-muted); display: none"
                  >Contact admin to update your profile.</small
                >
              </div>
              <div class="form-group">
                <label>Phone</label>
                <input
                  type="tel"
                  id="profilePhone"
                  class="form-control"
                  placeholder="Your phone number"
                />
              </div>
              <div class="form-group">
                <label
                  >Telegram Chat ID
                  <small style="color: var(--text-muted)"
                    >(Optional - for notifications)</small
                  ></label
                >
                <input
                  type="text"
                  id="profileTelegram"
                  class="form-control"
                  placeholder="Your Telegram Chat ID"
                />
                <small
                  style="
                    color: var(--text-muted);
                    display: block;
                    margin-top: 5px;
                  "
                >
                  <i class="fa-solid fa-info-circle"></i>
                  To get your Chat ID: 1) Start chat with the bot, 2) Send
                  /start, 3) Check instructions below
                </small>
              </div>
              <div class="form-group">
                <label>Role</label>
                <input
                  type="text"
                  id="profileRole"
                  class="form-control"
                  readonly
                />
              </div>
              <button
                type="submit"
                class="btn btn-primary admin-only"
                id="saveProfileBtn"
                style="display: none"
              >
                <i class="fa-solid fa-save"></i> Save Changes
              </button>
            </form>
          </div>

          <!-- Change Password -->
          <div class="card">
            <div class="card-title">
              <i class="fa-solid fa-key"></i> Change Password
            </div>
            <form id="passwordForm">
              <div class="form-group">
                <label>Current Password</label>
                <input
                  type="password"
                  id="currentPassword"
                  class="form-control"
                  required
                />
              </div>
              <div class="form-group">
                <label>New Password</label>
                <input
                  type="password"
                  id="newPassword"
                  class="form-control"
                  required
                  minlength="6"
                />
              </div>
              <div class="form-group">
                <label>Confirm New Password</label>
                <input
                  type="password"
                  id="confirmPassword"
                  class="form-control"
                  required
                />
              </div>
              <button type="submit" class="btn btn-primary">
                <i class="fa-solid fa-key"></i> Update Password
              </button>
            </form>
          </div>
        </div>

        <!-- My Restrictions (User View) -->
        <div class="card" id="myRestrictionsCard">
          <div class="card-title">
            <i class="fa-solid fa-clock"></i> My Access Restrictions
          </div>
          <p
            style="
              font-size: 12px;
              color: var(--text-muted);
              margin-bottom: 15px;
            "
          >
            These restrictions are set by your administrator.
          </p>
          <div id="myRestrictions">
            <div class="empty-state">
              <i
                class="fa-solid fa-check-circle"
                style="color: var(--success)"
              ></i>
              <p>No restrictions applied</p>
            </div>
          </div>
        </div>

        <!-- Telegram Notifications Setup -->
        <div class="card">
          <div class="card-title">
            <i class="fa-brands fa-telegram"></i> Telegram Notifications Setup
          </div>
          <p
            style="
              font-size: 12px;
              color: var(--text-muted);
              margin-bottom: 15px;
            "
          >
            Get real-time alerts for blocked websites, security events, and
            network activities.
          </p>

          <div
            style="
              background: var(--bg-dark);
              padding: 15px;
              border-radius: 8px;
              border-left: 3px solid var(--primary);
            "
          >
            <h4
              style="
                font-size: 14px;
                margin-bottom: 10px;
                color: var(--primary);
              "
            >
              <i class="fa-solid fa-info-circle"></i> How to Get Your Chat ID:
            </h4>
            <ol
              style="
                font-size: 13px;
                line-height: 1.8;
                color: var(--text-secondary);
                margin-left: 20px;
              "
            >
              <li>
                Open Telegram and search for <strong>@userinfobot</strong>
              </li>
              <li>Start a chat and send <code>/start</code></li>
              <li>
                The bot will reply with your Chat ID (a number like: 123456789)
              </li>
              <li>
                Copy the Chat ID and paste it in the
                <strong>Telegram Chat ID</strong> field above
              </li>
              <li>
                Click <strong>Save Changes</strong> to enable notifications
              </li>
            </ol>
          </div>

          <div
            style="
              margin-top: 15px;
              background: var(--warning);
              padding: 12px;
              border-radius: 8px;
            "
          >
            <p style="font-size: 12px; margin: 0; color: #000">
              <i class="fa-solid fa-exclamation-triangle"></i>
              <strong>Note:</strong> You must first start a conversation with
              the AuthTrack bot for notifications to work. Contact your
              admin for the bot username.
            </p>
          </div>
        </div>

        <!-- User Management (Admin Only) -->
        <div class="card admin-only" id="userManagement" style="display: none">
          <div class="card-title">
            <i class="fa-solid fa-users-gear"></i> User Management
            <button
              class="btn btn-sm btn-primary"
              style="margin-left: auto"
              onclick="openAddUserModal()"
            >
              <i class="fa-solid fa-plus"></i> Add User
            </button>
          </div>
          <table class="data-table">
            <thead>
              <tr>
                <th>Email</th>
                <th>Name</th>
                <th>Role</th>
                <th>Status</th>
                <th>Last Login</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersTable">
              <tr>
                <td
                  colspan="6"
                  style="text-align: center; color: var(--text-muted)"
                >
                  Loading...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </main>
    </div>

    <!-- Edit User Modal (Admin) -->
    <div class="modal-overlay" id="editUserModal">
      <div class="modal">
        <div class="modal-header">
          <h3><i class="fa-solid fa-user-edit"></i> Edit User</h3>
          <button class="modal-close" onclick="closeEditUserModal()">
            &times;
          </button>
        </div>
        <form id="editUserForm">
          <input type="hidden" id="editUserId" />
          <div class="form-group">
            <label>Email</label>
            <input
              type="email"
              id="editUserEmail"
              class="form-control"
              readonly
            />
          </div>
          <div class="form-group">
            <label>Display Name</label>
            <input type="text" id="editUserName" class="form-control" />
          </div>
          <div class="form-group">
            <label>Phone</label>
            <input type="tel" id="editUserPhone" class="form-control" />
          </div>
          <div class="form-group">
            <label>Role</label>
            <select id="editUserRole" class="form-control">
              <option value="user">User</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="fa-solid fa-save"></i> Save Changes
          </button>
        </form>
      </div>
    </div>

    <script type="module">
      import { auth } from "/static/js/firebase-config.js";
      import {
        onAuthStateChanged,
        updatePassword,
        reauthenticateWithCredential,
        EmailAuthProvider,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      let currentUser = null;
      let userRole = "user";
      let userId = null;

      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "/login";
          return;
        }

        currentUser = user;
        document.getElementById("profileEmail").value = user.email;

        const sessionRes = await fetch("/api/auth/session");
        const session = await sessionRes.json();

        userId = session.userId;
        userRole = session.role;

        const roleBadge = document.getElementById("userRole");
        roleBadge.textContent = session.role.toUpperCase();
        roleBadge.className = "role-badge role-" + session.role;

        document.getElementById("profileRole").value = session.role;

        loadProfile();
        loadMyRestrictions();

        if (userRole === "admin") {
          document.querySelectorAll(".admin-only").forEach((el) => {
            el.style.display = "";
          });
          // Update message nav text for admin
          const msgNavText = document.getElementById("msgNavText");
          if (msgNavText) msgNavText.textContent = "Requests";
          loadAllUsers();
        } else {
          // For regular users, make profile fields read-only
          document.querySelectorAll(".user-only").forEach((el) => {
            el.style.display = "";
          });
          document.getElementById("profileName").readOnly = true;
          document.getElementById("profilePhone").readOnly = true;
          document.getElementById("profileTelegram").readOnly = true;
        }
      });

      async function loadProfile() {
        const res = await fetch(`/api/users/${userId}`);
        const profile = await res.json();

        if (profile) {
          document.getElementById("profileName").value =
            profile.displayName || "";
          document.getElementById("profilePhone").value = profile.phone || "";
          document.getElementById("profileTelegram").value =
            profile.telegram_chat_id || "";
        }
      }

      async function loadMyRestrictions() {
        const container = document.getElementById("myRestrictions");

        // Get restrictions
        const restrictRes = await fetch(`/api/restrictions?userId=${userId}`);
        const restrictions = await restrictRes.json();

        // Get blocked sites
        const blockedRes = await fetch(`/api/blocked-sites?userId=${userId}`);
        const blocked = await blockedRes.json();

        let html = "";

        // Show internet schedule
        if (restrictions.internet && restrictions.internet.schedule) {
          html +=
            '<h4 style="font-size: 14px; margin-bottom: 10px;">Internet Schedule</h4>';
          restrictions.internet.schedule.forEach((sched) => {
            html += `
            <div style="padding: 10px; background: var(--bg-dark); border-radius: 8px; margin-bottom: 10px;">
              <strong>${sched.day}</strong>: ${sched.startTime} - ${
              sched.endTime
            }
              <span class="status ${
                sched.allowed ? "status-online" : "status-blocked"
              }" style="margin-left: 10px;">
                ${sched.allowed ? "Allowed" : "Blocked"}
              </span>
            </div>
          `;
          });
        }

        // Show blocked sites
        if (blocked && blocked.length > 0) {
          html +=
            '<h4 style="font-size: 14px; margin: 20px 0 10px;">Blocked Sites</h4>';
          html += '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
          blocked.forEach((site) => {
            html += `<span class="status status-blocked">${site}</span>`;
          });
          html += "</div>";
        }

        if (!html) {
          html = `
          <div class="empty-state">
            <i class="fa-solid fa-check-circle" style="color: var(--success);"></i>
            <p>No restrictions applied to your account</p>
          </div>
        `;
        }

        container.innerHTML = html;
      }

      // Save profile
      document
        .getElementById("profileForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const data = {
            displayName: document.getElementById("profileName").value,
            phone: document.getElementById("profilePhone").value,
            telegram_chat_id: document.getElementById("profileTelegram").value,
          };

          await fetch(`/api/users/${userId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          alert("Profile updated!");
        });

      // Change password
      document
        .getElementById("passwordForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const currentPwd = document.getElementById("currentPassword").value;
          const newPwd = document.getElementById("newPassword").value;
          const confirmPwd = document.getElementById("confirmPassword").value;

          if (newPwd !== confirmPwd) {
            alert("New passwords do not match!");
            return;
          }

          if (newPwd.length < 6) {
            alert("Password must be at least 6 characters!");
            return;
          }

          try {
            // Re-authenticate
            const credential = EmailAuthProvider.credential(
              currentUser.email,
              currentPwd
            );
            await reauthenticateWithCredential(currentUser, credential);

            // Update password
            await updatePassword(currentUser, newPwd);

            alert("Password updated successfully!");
            document.getElementById("passwordForm").reset();
          } catch (error) {
            console.error("Password change error:", error);
            if (error.code === "auth/wrong-password") {
              alert("Current password is incorrect");
            } else {
              alert("Failed to change password: " + error.message);
            }
          }
        });

      // Admin: Load all users
      async function loadAllUsers() {
        const res = await fetch("/api/users");
        const users = await res.json();

        const tbody = document.getElementById("usersTable");

        if (users.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" style="text-align: center;">No users found</td></tr>';
          return;
        }

        tbody.innerHTML = users
          .map(
            (user) => `
        <tr>
          <td>${user.email}</td>
          <td>${user.displayName || "-"}</td>
          <td><span class="role-badge role-${user.role}">${
              user.role
            }</span></td>
          <td><span class="status ${
            user.online ? "status-online" : "status-offline"
          }">${user.online ? "Online" : "Offline"}</span></td>
          <td>${
            user.lastLogin ? new Date(user.lastLogin).toLocaleString() : "-"
          }</td>
          <td>
            <button class="btn btn-sm btn-outline" onclick="editUser('${
              user.id
            }')">
              <i class="fa-solid fa-edit"></i>
            </button>
            ${
              user.id !== userId
                ? `
              <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}')">
                <i class="fa-solid fa-trash"></i>
              </button>
            `
                : ""
            }
          </td>
        </tr>
      `
          )
          .join("");
      }

      // Edit user
      window.editUser = async function (uid) {
        const res = await fetch(`/api/users/${uid}`);
        const user = await res.json();

        document.getElementById("editUserId").value = uid;
        document.getElementById("editUserEmail").value = user.email;
        document.getElementById("editUserName").value = user.displayName || "";
        document.getElementById("editUserPhone").value = user.phone || "";
        document.getElementById("editUserRole").value = user.role || "user";

        document.getElementById("editUserModal").classList.add("active");
      };

      window.closeEditUserModal = function () {
        document.getElementById("editUserModal").classList.remove("active");
      };

      document
        .getElementById("editUserForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const uid = document.getElementById("editUserId").value;
          const data = {
            displayName: document.getElementById("editUserName").value,
            phone: document.getElementById("editUserPhone").value,
            role: document.getElementById("editUserRole").value,
          };

          await fetch(`/api/users/${uid}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          closeEditUserModal();
          loadAllUsers();
          alert("User updated!");
        });

      // Delete user
      window.deleteUser = async function (uid) {
        if (!confirm("Are you sure you want to delete this user?")) return;

        await fetch(`/api/users/${uid}`, { method: "DELETE" });
        loadAllUsers();
      };

      // System stats update
      async function updateSystemStats() {
        try {
          const response = await fetch("/api/system/stats");
          const data = await response.json();

          document.querySelector(".fill.cpu").style.width = data.cpu + "%";
          document.getElementById("cpuVal").textContent = data.cpu + "%";

          document.querySelector(".fill.memory").style.width =
            data.memory + "%";
          document.getElementById("memVal").textContent = data.memory + "%";

          document.querySelector(".fill.disk").style.width = data.disk + "%";
          document.getElementById("diskVal").textContent = data.disk + "%";
        } catch (error) {
          console.error("Failed to update system stats:", error);
        }
      }

      // Update system stats every 2 seconds
      setInterval(updateSystemStats, 2000);
      updateSystemStats();
    </script>
  </body>
</html>
