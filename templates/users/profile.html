<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AuthTrack - My Profile</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="/static/css/style.css" />
    <style>
      .alert {
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
      }
      .alert.show {
        display: block;
      }
      .alert.success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
        border-left: 4px solid var(--success);
      }
      .alert.error {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
        border-left: 4px solid var(--danger);
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-main);
        font-weight: 500;
        font-size: 14px;
      }
      .form-group input {
        width: 100%;
        padding: 12px;
        background: var(--bg-dark);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text-main);
        font-size: 14px;
      }
      .form-group input:focus {
        outline: none;
        border-color: var(--primary);
      }
      .form-group input:disabled {
        background: var(--bg-card);
        cursor: not-allowed;
        opacity: 0.7;
      }
      .btn-submit {
        background: var(--primary);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
      }
      .btn-submit:hover {
        background: var(--primary-hover);
      }
      .btn-submit:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="logo">
          <i class="fa-solid fa-network-wired"></i> AuthTrack
        </div>
        <nav>
          <a href="/user/dashboard" class="nav-item">
            <i class="fa-solid fa-chart-line"></i> Dashboard
          </a>
          <a href="/user/traffic" class="nav-item">
            <i class="fa-solid fa-signal"></i> My Traffic
          </a>
          <a href="/user/restrictions" class="nav-item">
            <i class="fa-solid fa-shield-halved"></i> My Restrictions
          </a>
          <a href="/user/requests" class="nav-item">
            <i class="fa-solid fa-envelope"></i> Contact Admin
          </a>
          <a href="/user/profile" class="nav-item active">
            <i class="fa-solid fa-user"></i> My Profile
          </a>
          <a href="/logout" class="nav-item" style="margin-top: auto">
            <i class="fa-solid fa-right-from-bracket"></i> Logout
          </a>
        </nav>

        <!-- System Stats -->
        <div style="margin-top: auto">
          <div class="system-stats">
            <div class="title">
              <i class="fa-solid fa-microchip"></i> System Status
            </div>
            <div class="sys-stat">
              <div class="header">
                <span>CPU</span>
                <span id="cpuVal">0%</span>
              </div>
              <div class="bar">
                <div class="fill cpu" id="cpuBar" style="width: 0%"></div>
              </div>
            </div>
            <div class="sys-stat">
              <div class="header">
                <span>Memory</span>
                <span id="memVal">0%</span>
              </div>
              <div class="bar">
                <div class="fill memory" id="memBar" style="width: 0%"></div>
              </div>
            </div>
            <div class="sys-stat">
              <div class="header">
                <span>Disk</span>
                <span id="diskVal">0%</span>
              </div>
              <div class="bar">
                <div class="fill disk" id="diskBar" style="width: 0%"></div>
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <header class="header">
          <h1>My Profile</h1>
          <div class="header-actions">
            <span class="user-email" id="userEmailHeader">Loading...</span>
          </div>
        </header>

        <!-- Profile Information -->
        <div class="card">
          <div class="card-header">
            <h3><i class="fa-solid fa-id-card"></i> Profile Information</h3>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label><i class="fa-solid fa-envelope"></i> Email</label>
              <input type="email" id="profileEmail" disabled value="" />
            </div>
            <div class="form-group">
              <label><i class="fa-solid fa-hashtag"></i> User ID</label>
              <input type="text" id="profileUserId" disabled value="" />
            </div>
            <div class="form-group">
              <label>
                <i class="fa-brands fa-telegram"></i> Telegram Chat ID
                <small style="color: var(--text-muted)"
                  >(Optional - for notifications)</small
                >
              </label>
              <input
                type="text"
                id="profileTelegram"
                placeholder="Your Telegram Chat ID"
                value=""
              />
              <small
                style="
                  color: var(--text-muted);
                  display: block;
                  margin-top: 5px;
                  font-size: 12px;
                "
              >
                <i class="fa-solid fa-info-circle"></i>
                Message <strong>@userinfobot</strong> on Telegram to get your
                Chat ID
              </small>
            </div>
            <div class="form-group">
              <label><i class="fa-solid fa-shield"></i> Role</label>
              <input type="text" id="profileRole" disabled value="User" />
            </div>
            <button type="button" onclick="saveProfile()" class="btn-submit">
              <i class="fa-solid fa-save"></i> Save Profile
            </button>
          </div>
        </div>

        <!-- Change Password -->
        <div class="card">
          <div class="card-header">
            <h3><i class="fa-solid fa-key"></i> Change Password</h3>
          </div>
          <div class="card-body">
            <div id="passwordAlert" class="alert"></div>
            <p style="color: var(--text-muted); margin-bottom: 20px">
              <i class="fa-solid fa-info-circle"></i> Password change
              functionality requires backend implementation. Please contact
              administrator to reset your password.
            </p>
            <form onsubmit="changePassword(event)">
              <div class="form-group">
                <label><i class="fa-solid fa-lock"></i> Current Password</label>
                <input
                  type="password"
                  id="currentPassword"
                  placeholder="Enter current password"
                  required
                />
              </div>
              <div class="form-group">
                <label><i class="fa-solid fa-lock"></i> New Password</label>
                <input
                  type="password"
                  id="newPassword"
                  placeholder="Enter new password"
                  required
                />
              </div>
              <div class="form-group">
                <label
                  ><i class="fa-solid fa-lock"></i> Confirm New Password</label
                >
                <input
                  type="password"
                  id="confirmPassword"
                  placeholder="Confirm new password"
                  required
                />
              </div>
              <button type="submit" class="btn-submit" id="changePasswordBtn">
                <i class="fa-solid fa-key"></i> Update Password
              </button>
            </form>
          </div>
        </div>
      </main>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        await loadUserInfo();
        updateSystemStats();
        setInterval(updateSystemStats, 2000);
      });

      async function loadUserInfo() {
        try {
          const response = await fetch("/api/auth/session");
          const data = await response.json();
          if (data.loggedIn) {
            document.getElementById("userEmailHeader").textContent = data.email;
            document.getElementById("profileEmail").value = data.email;
            document.getElementById("profileUserId").value = data.userId;

            // Load Telegram Chat ID
            const userResponse = await fetch(`/api/users/${data.userId}`);
            const userData = await userResponse.json();
            if (userData && userData.telegram_chat_id) {
              document.getElementById("profileTelegram").value =
                userData.telegram_chat_id;
            }
          }
        } catch (error) {
          console.error("Failed to load user info:", error);
        }
      }

      async function saveProfile() {
        try {
          const response = await fetch("/api/auth/session");
          const sessionData = await response.json();

          if (!sessionData.loggedIn) {
            alert("Session expired. Please login again.");
            return;
          }

          const telegram_chat_id = document
            .getElementById("profileTelegram")
            .value.trim();

          const updateResponse = await fetch(
            `/api/users/${sessionData.userId}`,
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ telegram_chat_id }),
            },
          );

          if (updateResponse.ok) {
            alert(
              "Profile updated successfully! You will now receive Telegram notifications.",
            );
          } else {
            alert("Failed to update profile. Please try again.");
          }
        } catch (error) {
          console.error("Failed to save profile:", error);
          alert("An error occurred. Please try again.");
        }
      }

      async function changePassword(event) {
        event.preventDefault();

        const currentPass = document.getElementById("currentPassword").value;
        const newPass = document.getElementById("newPassword").value;
        const confirmPass = document.getElementById("confirmPassword").value;
        const alert = document.getElementById("passwordAlert");

        // Validation
        if (!currentPass || !newPass || !confirmPass) {
          alert.className = "alert error show";
          alert.innerHTML =
            '<i class="fa-solid fa-exclamation-circle"></i> Please fill in all password fields!';
          setTimeout(() => (alert.className = "alert"), 3000);
          return;
        }

        if (newPass !== confirmPass) {
          alert.className = "alert error show";
          alert.innerHTML =
            '<i class="fa-solid fa-exclamation-circle"></i> New passwords do not match!';
          setTimeout(() => (alert.className = "alert"), 3000);
          return;
        }

        if (newPass.length < 6) {
          alert.className = "alert error show";
          alert.innerHTML =
            '<i class="fa-solid fa-exclamation-circle"></i> Password must be at least 6 characters!';
          setTimeout(() => (alert.className = "alert"), 3000);
          return;
        }

        // Show info message about using Firebase password reset
        alert.className = "alert info show";
        alert.innerHTML =
          '<i class="fa-solid fa-info-circle"></i> To change your password, please log out and use the "Forgot Password" link on the login page. You will receive a password reset email.';
      }

      async function updateSystemStats() {
        try {
          const response = await fetch("/api/system/stats");
          const data = await response.json();

          document.getElementById("cpuVal").textContent = data.cpu + "%";
          document.getElementById("cpuBar").style.width = data.cpu + "%";

          document.getElementById("memVal").textContent = data.memory + "%";
          document.getElementById("memBar").style.width = data.memory + "%";

          document.getElementById("diskVal").textContent = data.disk + "%";
          document.getElementById("diskBar").style.width = data.disk + "%";
        } catch (error) {
          console.error("Failed to update system stats:", error);
        }
      }
    </script>
  </body>
</html>
